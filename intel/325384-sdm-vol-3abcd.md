[toc]

### 25.8.3 事件注入的VM入口控制

虚拟机入口可以配置为通过IDT发送事件来结束（在所有Guest状态和MSR加载完成后）。这个过程称为事件注入，并由以下三个虚拟机入口控制字段控制

- **VM-enrty interruption-information field**(虚拟机入口中断信息字段)(32 bits)。该字段提供要注入事件的详细信息.。

  <center>Table 25 -17. Format of the VM-Entry Interruption-Information Field</center>
  
  | Bit Position(s) | Content                                                      |
  | --------------- | ------------------------------------------------------------ |
  | 7:0           | 中断或异常向量                                               |
  | 10:8          | 中断类型：<br>&nbsp;&nbsp;0：Exteral interrupt外部中断<br>&nbsp;&nbsp;1：Reserved保留<br>&nbsp;&nbsp;2：Non-maskable interrupt不可屏蔽中断(NMI)<br/>&nbsp;&nbsp;3：Hardware exception硬件异常(例如 #PF)<br/>&nbsp;&nbsp;4：Software interrupt软件中断(INT n)<br/>&nbsp;&nbsp;5：Privileged software exception特权软件异常(INT 1)<br/>&nbsp;&nbsp;6：Software exception软件异常(INT3 or INTO)<br/>&nbsp;&nbsp;7：Other Event其他事件 |
  | 11            | 传递错误码(0 = 不传递; 1 = 传递)                             |
  | 30:12         | 保留位                                                       |
  | 31            | 有效位                                                       |
  
  - 这个**vector**(bits 7:0)决定使用IDT中哪个条目或者注入哪个事件
  - 这个**interruption type**(bits 10:8)决定注入执行的细节。一般来说，VMM应该对所有异常类型使用硬件异常**除以下情况**
    - 断点异常(#BP; VMM 应该使用的类型是软件异常)
    - 溢出异常(#OF; VMM应该使用的类型是软件异常)
    - 以及由INT1 生成的其他调试异常(#DB)(VMM应该使用特权软件异常)
  - 仅当有效位(bit 31)为1时，VM入口才会注入事件。此字段中的有效位在每次VM退出时被清除[查看28.2节](#28.2 记录 VM-退出信息并更新 VM-进入控制字段)。
  
- **VM-entry exception error code**(32 bits)仅当在入口中断信息字段的有效位(bit 31)和传递错误码位(bit 11)都被设置时才会使用此字段

- **VM-entry instruction length**(32 bits)对于注入事件类型是软件中断、软件异常还是特权软件异常，这个字段决定使用RIP的值压入栈中。

有关事件注入详细细节，请查看27.6节，包括中断类型的使用和虚拟机进入指令的长度

虚拟机退出会清除虚拟机进入中断信息字段的有效位(bit 31)

## 27.6 事件注入

如果虚拟机进入中断信息字段(查看25.8.3)的有效位是1，则虚拟入口会在所有客户状态组件(包括MSR)加载完成后，以及虚拟机执行控制字段建立后，导致时间被传递(或待处理)

- 如果字段中的中断类型是 0（外部中断）、2（不可屏蔽中断）、3（硬件异常）、4（软件中断）、5（特权软件异常）或 6（软件异常），则事件按照第 27.6.1 节的描述进行传递。
- 如果字段中的中断类型是 7（其他事件）且向量字段为 0，则在虚拟机进入后会有一个 MTF VM 退出待处理。详见第 27.6.2 节。

### 27.6.1 向量事件注入

虚拟机进入（VM entry）会在虚拟机进入时建立的客户机上下文中传递注入的向量事件。

***

<div STYLE="page-break-after: always;"></div>

这意味着事件传递会在所有客户机状态的组件（包括 MSR）加载完毕之后，以及在 VM 执行控制字段建立之后进行[^1]。事件使用字段中的向量从 IDT 中选择一个描述符进行传递。由于事件注入是在从客户机状态区加载 IDTR 之后发生的，因此使用的是客户机的 IDT。第 27.6.1.1 节详细描述了向量事件注入。通常情况下，事件的传递与其正常生成时的方式完全一致。

如果满足以下条件，会有一个例外情况：客户机 CR4 字段中的第 25 位（UINTR）设置为 1，且“IA-32e 模式客户机” VM 进入控制为 1，并且虚拟机进入正在注入一个向量值等于 VM 进入后 UINV 值的外部中断。在这种情况下，逻辑处理器会按照第 7.5.2 节的规定执行用户中断通知处理，而不是按照第 27.6.1.1 节的过程。（如果客户机的活动状态字段指示处于 HLT 状态，逻辑处理器在用户中断通知处理后会进入 HLT 状态。）

如果事件传递（或用户中断通知处理，见上文）遇到嵌套异常（例如，向量指示的描述符超出了 IDT 限制，导致了通用保护异常），则使用该异常的向量查阅异常位图：

- 如果嵌套异常的位为 0，则嵌套异常会正常传递。如果嵌套异常是良性的，则通过 IDT 传递；如果是协同异常或页面错误，可能会根据遇到嵌套异常的事件的性质生成双重错误。参见第 6 章，《Intel® 64 和 IA-32 架构软件开发人员手册》第 3A 卷中的“Interrupt 8——Double Fault Exception (#DF)”[^2]。
- 如果嵌套异常的位为 1，则会发生 VM 退出。第 27.6.1.2 节详细说明了事件注入引发 VM 退出的情况。

#### 27.6.1.1 向量注入事件细节

事件注入过程是由虚拟机进入中断信息字段的内容(格式在Table 25-17给出)、虚拟机进入异常错误码字段和虚拟机进入指令长度字段控制。过程的具体详细细节如下：

- 从栈推送到RFLAGS的这个值通常来自于guest-state area加载的值。推送到RF标志值不会根据传递的事件类型进行修改。然而，如果将软件中断注入到将处于virtual-8086模式的guest中，RFLAGS的推送值可能会被修改（见下文）。在RFLAGS被推送到栈上后，RFLAGS寄存器中的值会像通过IDT传递事件时那样被修改。
- 被推送到栈上的指令指针取决于事件的类型以及在其传递过程中是否发生嵌套异常。术语**current guest RIP(当前客户机RIP)**[^3]指的是要从guest-state area加载的值。推送的值确定如下：
  - 如果VM进入操作成功注入了(且没有嵌套异常)中断类型为 external interrupt(外部中断)、NMI(不可屏蔽中断)或者hardware exception(硬件异常)的事件，则当前客户机RIP会被压入栈中。
  - 如果 VM 进入操作成功注入了（且没有嵌套异常）中断类型为software interrupt、privileged software exception、或者software exception的事件，在压入栈之前，当前客户机 RIP 会被 VM 进入指令长度递增。
  - 如果 VM 进入操作在注入事件时遇到异常，且该异常不会导致 VM 退出，则无论事件类型或 VM 进入指令长度如何，当前客户机 RIP 都会被压入栈中。如果遇到的异常导致 VM 退出并保存 RIP，则保存的 RIP 为当前客户机 RIP。
- 如果 VM 进入中断信息字段中的 deliver-error-code 位（第 11 位）被设置，则 VM 进入异常错误码字段的内容会像异常传递时一样作为错误码被压入栈中。

***

[^1]:这并不意味着由于VM执行控制字段(例如 the exception bitmap)的设置，导致异常或中断的注入会触发虚拟机退出。如果该事件发生在VMX非根模式下，这些设置本来会导致VM退出。相反，在事件传递过程中遇到的嵌套异常可能会导致VM退出。

[^2]:以下未使用的向量引发的硬件异常被视为良性异常：15 和 21-31。向量 20 的硬件异常通常也被视为良性异常，除非处理器支持 "EPT 违规 #VE" VM 执行控制的 1 设置；在这种情况下，该异常的严重性与页面错误相同。

[^3]:虽然这些涉及RIP，但推送的值的宽度(16 bit、32 bit或64 bit)通常是确定的。

<div STYLE="page-break-after: always;"></div>

- 即使事情的向量为1(调试异常的正常传递，其向量为1会更新这些寄存器)，通过事件注入时，DR6、DR7和IA32_DEBUGCTL_MSR不会被修改。

- 如果VM进入操作正在注入 一个软件中断，且客户机将处于虚拟8086模式(RFLAGS.VM = 1),由于RFLAGS.IOPL<3，不会发生一般保护异常。VM监控程序应在注入此类事件前检查RFLAGS.IOPL，如果需要，可以注入一般保护异常而不是软件中断。

- 如果VM进入操作正在注入一个软件中断，且客户机将处于启用虚拟8086模式扩展的虚拟8086模式(RFLAGS.VM = CR4.VME = 1)，事件传递将受到基于任务状态段(TSS)中的软件中断重定向bit map的VME重定向机制的影响，如下所示：

  - 如果bit map中的第n位(n为软件中断编号)被清除，中断将被定向到8086程序中断处理程序：处理器将使用位于线性地址为0的16为中断向量表(IVT)。如果RFLAGS.IOPL的值小于3,则对栈中被压入的RFLAGS值进行以下修改：IOPL设置为3,IF设置为VIF的值。
  - 如果bit map中的第n位被设置，中断将被定向到保护模式中断出来程序。(换句话说，注入按照下一项所述处理)。在这种情况下，如果RFLAGS.IOPL<3，软件中断不会调用此类处理程序(相反，会发生一般保护异常)。然而，如上所述，RFLAGS.IOPL无法导致注入的软件中断引发此类异常。因此，在这种情况下，无论RFLAGS.IOPL的值如何，注入都会调用保护迷失中断处理程序。

  其他类型事件的注入不受此重定向影响。

- 如果VM进入操作正在注入一个软件中断(未按上述方式重定向)或软件异常，则会对访问的IDT描述符进行权限检查，就像执行INT n、INT3或INTO指令时那样(描述符的DPL不能小于CPL)。即使客户机将处于虚拟8086模式，也不会检查RFLAGS.IOPL。如果此检查失败，可能会导致嵌套异常。注入中断类型为extrenal interrupt、NMI、hardware exception、privileged software exception，或注入的中断类型为software interrupt并按上述方式重定向的事件，不执行这些检查。

- 如果VM进入操作正在注入不可屏蔽中断(NMI)且"virtual NMIs" VM-excution control是1,则在进入后virtual-NMI阻塞生效。

- 如果IA32_DEBUGCYL_MSR中的LBR bit 被设置，则该过渡会记录最后分支记录。即使像调试器这样的事件，通常在传递前会清除LBR bit，但也会记录最后的分支。

- 最后异常记录MSR(LER)可能会基于IA32_DEBUGCTL_MSR中LBR bit的设置进行更新。通常在传递前清除LBR bit的事件(如调试异常)，因此不会通常更新LER，但在VM进入事件注入过程中可能会更新。

- 如果事件注入过程中遇到嵌套异常，任何嵌套异常错误码中的EXT bit(第 0 位)的值按照如下方式确定：

  - 如果 被注入的事件的中断类型为xtrenal interrupt、NMI、hardware exception、privileged software exception，且遇到嵌套异常(但未产生双重错误)，则该异常的错误码会设置EXT bit。
  - 如果被注入的事件是software interrupt或software exception，且遇到嵌套异常，则该异常的错误码会清除 EXT 位。
  - 如果事件传递遇到嵌套异常，且该异常的传递遇到另一个异常(但未产生双重错误)，则该异常的错误码会设置EXT位。
  - 如果产生双重错误，则双重错误的错误码为0000H(EXT位被清除)

#### 27.6.1.2 事件注入期间的虚拟机VM退出

















































